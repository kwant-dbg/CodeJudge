<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeJudge - Monolith</title>
    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --accent: #1a1a1a;
            --accent-hover: #333333;
            --card-bg: #ffffff;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #282828;
            --text-primary: #eff1f6;
            --text-secondary: #a0a0a0;
            --border-color: #3a3a3a;
            --accent: #eff1f6;
            --accent-hover: #d0d0d0;
            --card-bg: #262626;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            min-height: 100vh; 
            padding: 0;
            line-height: 1.5;
            font-weight: 400;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container { max-width: 100%; margin: 0; padding: 0; }
        .card { 
            background: var(--card-bg); 
            color: var(--text-primary);
            border: none;
            padding: 24px 32px; 
            margin: 0;
            min-height: 80vh;
            transition: background-color 0.3s ease;
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 10px 32px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        h1 { 
            color: var(--text-primary); 
            font-size: 26px; 
            font-weight: 700; 
            letter-spacing: -1px;
            line-height: 1;
            transition: color 0.3s ease;
        }
        .subtitle { 
            color: var(--text-secondary); 
            font-size: 11px; 
            font-weight: 400;
            letter-spacing: 0.3px;
            margin-top: 4px;
            transition: color 0.3s ease;
        }
        .theme-toggle {
            background: var(--accent);
            color: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 0;
            cursor: pointer;
            font-size: 18px;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            flex-shrink: 0;
        }
        .theme-toggle:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }
        .user-info { 
            color: var(--bg-primary); 
            font-weight: 600; 
            background: var(--accent); 
            padding: 8px 16px; 
            border: none;
            font-size: 13px;
            letter-spacing: 0.3px;
            transition: all 0.3s ease;
        }
        button { 
            background: var(--accent); 
            color: var(--bg-primary); 
            padding: 10px 20px; 
            border: 1px solid var(--accent); 
            cursor: pointer; 
            font-size: 13px; 
            font-weight: 600; 
            letter-spacing: 0.5px;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        button:hover { 
            background: var(--bg-primary); 
            color: var(--accent); 
            border: 1px solid var(--accent);
        }
        button.secondary { 
            background: var(--bg-primary); 
            color: var(--accent); 
            border: 1px solid var(--border-color); 
        }
        button.secondary:hover { 
            background: var(--accent); 
            color: var(--bg-primary); 
            border: 1px solid var(--accent);
        }
        button.danger { background: #d00; border: 1px solid #d00; color: #fff; }
        button.danger:hover { background: #fff; color: #d00; border: 1px solid #d00; }
        .hidden { display: none !important; }
        input, textarea, select { 
            width: 100%; 
            padding: 10px 14px; 
            margin: 6px 0; 
            border: 1px solid var(--border-color); 
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: var(--accent); 
            background: var(--card-bg);
        }
        .form-group { margin-bottom: 16px; }
        .form-group label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: var(--text-primary);
            font-size: 12px;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
        }
        .status { 
            padding: 12px 20px; 
            margin: 0; 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            max-width: 350px; 
            z-index: 1000;
            border: 1px solid var(--border-color);
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        .status.success { background: var(--accent); color: var(--bg-primary); }
        .status.error { background: #d00; color: #fff; border-color: #d00; }
        .problem-item { 
            background: var(--card-bg); 
            padding: 16px 0; 
            margin: 0; 
            border-bottom: 1px solid var(--border-color); 
            cursor: pointer; 
            transition: all 0.3s ease;
        }
        .problem-item:hover { 
            background: var(--bg-secondary); 
            padding-left: 12px;
        }
        .problem-title { 
            font-weight: 600; 
            font-size: 16px; 
            color: var(--text-primary);
            letter-spacing: -0.3px;
            margin-bottom: 6px;
            transition: color 0.3s ease;
        }
        .problem-meta { 
            font-size: 13px; 
            color: var(--text-secondary); 
            margin-top: 4px;
            font-weight: 400;
            letter-spacing: 0.2px;
            transition: color 0.3s ease;
        }
        .badge { 
            display: inline-block; 
            padding: 3px 10px; 
            font-size: 10px; 
            font-weight: 600;
            border: 1px solid var(--accent);
            letter-spacing: 0.3px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        .badge-easy { background: var(--bg-primary); color: #00b8a3; border-color: #00b8a3; }
        .badge-medium { background: var(--bg-primary); color: #ffa116; border-color: #ffa116; }
        .badge-hard { background: var(--bg-primary); color: #ef4743; border-color: #ef4743; }
        .workflow-steps { 
            background: var(--bg-secondary); 
            padding: 24px;
            transition: background-color 0.3s ease;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }
        .workflow-steps h3 { 
            color: var(--text-primary); 
            margin-bottom: 16px;
            font-weight: 600;
            font-size: 18px;
            letter-spacing: -0.5px;
            transition: color 0.3s ease;
        }
        .workflow-steps ol { margin-left: 20px; }
        .workflow-steps li { 
            margin: 8px 0; 
            color: var(--text-primary);
            font-weight: 400;
            line-height: 1.5;
            transition: color 0.3s ease;
        }
        code { 
            background: var(--bg-secondary); 
            color: var(--text-primary);
            padding: 3px 8px; 
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div>
                    <h1>CodeJudge</h1>
                    <div class="subtitle">Online Coding Platform</div>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <span id="themeIcon">🌙</span>
                </button>
            </div>
            <div class="auth-section">
                <span id="userInfo" class="user-info hidden"></span>
                <button id="loginBtn" onclick="showLogin()">Login</button>
                <button id="registerBtn" onclick="showRegister()">Register</button>
                <button id="logoutBtn" class="hidden danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="card">
            <h2 style="margin-bottom: 24px; font-size: 32px; font-weight: 600; letter-spacing: -1.5px;">Welcome to CodeJudge</h2>
            <div class="workflow-steps">
                <h3>How it works</h3>
                <ol>
                    <li><strong>Register or Login</strong> — Create an account to get started</li>
                    <li><strong>Browse Problems</strong> — View available coding challenges</li>
                    <li><strong>Create Problems</strong> — Add your own challenges</li>
                    <li><strong>Submit Solutions</strong> — Write and submit code</li>
                    <li><strong>View Results</strong> — Get instant feedback on your submissions</li>
                </ol>
            </div>
            <p style="margin: 20px 0; color: var(--text-secondary); font-weight: 500; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); transition: all 0.3s ease;">Authentication required to access problems and submit solutions</p>
            <div style="display: flex; gap: 10px;">
                <button onclick="showRegister()" style="flex: 1;">Register</button>
                <button class="secondary" onclick="showLogin()" style="flex: 1;">Login</button>
            </div>
        </div>

        <!-- Auth Form -->
        <div id="authForm" class="card hidden">
            <h2 id="authTitle" style="margin-bottom: 24px; font-size: 32px; font-weight: 600; letter-spacing: -1.5px;">Login</h2>
            <form id="loginForm" style="max-width: 500px;">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button type="submit" style="flex: 1;">Login</button>
                    <button type="button" class="secondary" onclick="hideAuth()" style="flex: 1;">Cancel</button>
                </div>
                <p style="margin-top: 32px; text-align: center; color: #666;">Don't have an account? <a href="#" onclick="showRegister(); return false;" style="color: #000; text-decoration: none; border-bottom: 1px solid #000; font-weight: 500;">Register here</a></p>
            </form>
            
            <form id="registerForm" class="hidden" style="max-width: 500px;">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="registerUsername" placeholder="Choose a username" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" placeholder="Minimum 6 characters" required minlength="6">
                </div>
                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button type="submit" style="flex: 1;">Register</button>
                    <button type="button" class="secondary" onclick="hideAuth()" style="flex: 1;">Cancel</button>
                </div>
                <p style="margin-top: 32px; text-align: center; color: #666;">Already have an account? <a href="#" onclick="showLogin(); return false;" style="color: #000; text-decoration: none; border-bottom: 1px solid #000; font-weight: 500;">Login here</a></p>
            </form>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="card hidden">
            <!-- Quick Action Links -->
            <div style="margin-bottom: 24px;">
                <a href="/create-problem.html" style="display: inline-block; background: var(--accent); color: var(--bg-primary); padding: 10px 20px; text-decoration: none; font-weight: 600; font-size: 13px; letter-spacing: 0.5px; border: 1px solid var(--accent); transition: all 0.2s ease;" onmouseover="this.style.background='var(--bg-primary)'; this.style.color='var(--accent)';" onmouseout="this.style.background='var(--accent)'; this.style.color='var(--bg-primary)';">
                    Create New Problem
                </a>
            </div>

            <!-- Problems Tab -->
            <div id="problemsTab" class="tab-content">
                <h2 style="margin-bottom: 16px; font-size: 24px; font-weight: 600; letter-spacing: -1px;">Problems</h2>
                <div id="problemsList" style="padding: 0 0 24px 0;"></div>
            </div>

        </div>

        <div id="status"></div>
    </div>

    <script>
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let problems = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                validateToken();
            }
            // Initialize KaTeX auto-render for the whole page
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ]
                });
            }
        });

        // Tab switching removed - using dedicated pages now

        function showLogin() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('authForm').classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Login';
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('authForm').classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Register';
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
        }

        function hideAuth() {
            document.getElementById('authForm').classList.add('hidden');
            if (!currentUser) document.getElementById('welcomeScreen').classList.remove('hidden');
        }

        function showLoggedIn(user) {
            currentUser = user;
            document.getElementById('userInfo').textContent = '👤 ' + user.username;
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('authForm').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            loadProblems();
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('welcomeScreen').classList.remove('hidden');
            showStatus('Logged out successfully', 'success');
        }

        async function validateToken() {
            try {
                const response = await fetch('/api/auth/validate', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    const claims = await response.json();
                    showLoggedIn({ id: claims.user_id, username: claims.username, role: claims.role });
                } else {
                    logout();
                }
            } catch (err) {
                console.error('Token validation failed:', err);
                logout();
            }
        }

        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: { 'Content-Type': 'application/json' },
            };
            if (authToken) {
                defaultOptions.headers['Authorization'] = 'Bearer ' + authToken;
            }
            return fetch(url, { ...defaultOptions, ...options, headers: { ...defaultOptions.headers, ...options.headers } });
        }

        async function loadProblems() {
            try {
                const response = await apiRequest('/api/problems/');
                if (response.ok) {
                    problems = await response.json();
                    displayProblems();
                } else {
                    const error = await response.json();
                    showStatus('Failed to load problems: ' + (error.error || 'Unknown error'), 'error');
                }
            } catch (err) {
                showStatus('Network error loading problems: ' + err.message, 'error');
            }
        }

        function displayProblems() {
            const container = document.getElementById('problemsList');
            if (!problems || problems.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 60px 0; font-weight: 400; font-size: 16px;">No problems available. Create your first problem to get started.</p>';
                return;
            }
            container.innerHTML = problems.map(p => `
                <div class="problem-item" onclick="window.location.href='/problem.html?id=${p.id}'">
                    <div class="problem-title">${p.title}</div>
                    <div class="problem-meta">
                        <span class="badge badge-${p.difficulty}">${p.difficulty.charAt(0).toUpperCase() + p.difficulty.slice(1)}</span>
                        <span style="margin-left: 16px;">ID: ${p.id}</span>
                    </div>
                </div>
            `).join('');
        }

        // Removed - submissions now done on problem.html page

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('loginUsername').value,
                        password: document.getElementById('loginPassword').value
                    })
                });
                if (response.ok) {
                    const result = await response.json();
                    authToken = result.token;
                    localStorage.setItem('authToken', authToken);
                    showLoggedIn(result.user);
                    showStatus('Login successful! Welcome back!', 'success');
                    document.getElementById('loginForm').reset();
                } else {
                    const error = await response.json();
                    showStatus(error.error || 'Login failed', 'error');
                }
            } catch (err) {
                showStatus('Network error: ' + err.message, 'error');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('registerUsername').value,
                        email: document.getElementById('registerEmail').value,
                        password: document.getElementById('registerPassword').value
                    })
                });
                if (response.ok) {
                    const result = await response.json();
                    authToken = result.token;
                    localStorage.setItem('authToken', authToken);
                    showLoggedIn(result.user);
                    showStatus('Registration successful! Welcome to CodeJudge!', 'success');
                    document.getElementById('registerForm').reset();
                } else {
                    const error = await response.json();
                    showStatus(error.error || 'Registration failed', 'error');
                }
            } catch (err) {
                showStatus('Network error: ' + err.message, 'error');
            }
        });

        // Form handlers moved to dedicated pages (create-problem.html, problem.html)

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 5000);
        }

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const themeIcon = document.getElementById('themeIcon');
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeIcon.textContent = newTheme === 'dark' ? '☀️' : '🌙';
        }

        // Initialize theme from localStorage
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const themeIcon = document.getElementById('themeIcon');
            document.documentElement.setAttribute('data-theme', savedTheme);
            themeIcon.textContent = savedTheme === 'dark' ? '☀️' : '🌙';
        })();

        // Polling functions moved to problem.html
    </script>
</body>
</html>
